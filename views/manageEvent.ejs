<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kelola Acara - <%= event.name %></title>
    <link href="/public/output.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="/public/cameraCapture.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col font-sans">
    <header class="bg-white shadow-md p-6">
      <h1 class="text-4xl font-extrabold text-center text-gray-900">
        Kelola Acara: <%= event.name %>
      </h1>
    </header>
    <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">
      <section class="mb-12">
        <!-- Header for Guest Management -->
        <div class="flex items-center justify-between mb-8 border-b-4 border-blue-600 pb-4">
          <h2 class="text-3xl font-extrabold text-gray-900">Daftar Tamu</h2>
          <a
            href="/dashboard"
            aria-label="Kembali ke Dashboard"
            class="flex items-center justify-center w-12 h-12 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-shadow shadow-md hover:shadow-lg"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-7 w-7"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </a>
        </div>

        <% if (guests.length === 0) { %>
        <p class="text-center text-gray-600 text-lg mt-4">
          Belum ada tamu yang terdaftar.
        </p>
        <% } else { %>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
            <thead class="bg-blue-600 text-white">
              <tr>
                <th class="py-4 px-6 text-left">Foto</th>
                <th class="py-4 px-6 text-left">Nama</th>
                <th class="py-4 px-6 text-left">Email</th>
                <th class="py-4 px-6 text-left">No Telepon</th>
                <th class="py-4 px-6 text-center">Aksi</th>
              </tr>
            </thead>
            <tbody>
              <% guests.forEach(guest => { %>
              <tr class="border-b hover:bg-blue-50 transition">
                <td class="py-4 px-6">
                  <% if (guest.photo_url) { %>
                  <img
                    src="<%= guest.photo_url %>"
                    alt="Foto <%= guest.name %>"
                    class="w-12 h-12 rounded-full object-cover border border-gray-300"
                  />
                  <% } else { %>
                  <div
                    class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-medium border border-gray-300 text-sm"
                  >
                    No Photo
                  </div>
                  <% } %>
                </td>
                <td class="py-4 px-6 text-gray-800 font-semibold">
                  <%= guest.name %>
                </td>
                <td class="py-4 px-6 text-gray-600"><%= guest.email %></td>
                <td class="py-4 px-6 text-gray-600">
                  <%= guest.phone || '-' %>
                </td>
                <td class="py-4 px-6 text-center">
                  <button
                    type="button"
                    class="inline-block px-4 py-2 bg-green-600 text-white rounded-md shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition mr-2 print-invitation-btn"
                    data-guest-id="<%= guest.id %>"
                    data-guest-name="<%= guest.name %>"
                  >
                    Cetak Undangan
                  </button>
                  <form
                    action="/delete_guest/<%= guest.id %>"
                    method="POST"
                    onsubmit="return confirmDelete(event, this);"
                    class="inline-block"
                  >
                    <button
                      type="submit"
                      class="inline-block px-4 py-2 bg-red-600 text-white rounded-md shadow hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition"
                    >
                      Hapus
                    </button>
                  </form>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } %>

        <form
          id="add-guest-form"
          action="/add_guest/<%= event.id %>"
          method="POST"
          enctype="multipart/form-data"
          class="mt-10 space-y-6 bg-white p-6 rounded-lg shadow-md max-w-md mx-auto"
        >
          <h3 class="text-2xl font-bold text-gray-900 mb-4">
            Tambah Tamu Baru
          </h3>
          <div>
            <label for="name" class="block mb-2 font-semibold text-gray-700"
              >Nama</label
            >
            <input
              type="text"
              id="name"
              name="name"
              class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              required
            />
          </div>
          <div>
            <label for="email" class="block mb-2 font-semibold text-gray-700"
              >Email</label
            >
            <input
              type="email"
              id="email"
              name="email"
              class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              required
            />
          </div>
          <div>
            <label for="phone" class="block mb-2 font-semibold text-gray-700"
              >No Telepon</label
            >
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
            />
          </div>
          <div>
            <label class="block mb-2 font-semibold text-gray-700"
              >Foto Tamu</label
            >
            <div
              id="photoContainer"
              class="mb-3 relative w-64 h-48 rounded-lg border border-gray-300 overflow-hidden bg-gray-50"
            >
              <video
                id="video"
                autoplay
                playsinline
                class="w-full h-full object-cover rounded-lg"
              ></video>
              <img
                id="capturedPhoto"
                src=""
                alt="Foto Tamu"
                class="hidden w-full h-full object-cover rounded-lg absolute top-0 left-0"
              />
            </div>
            <div class="flex space-x-3">
              <button
                type="button"
                id="captureBtn"
                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              >
                Ambil Foto
              </button>
              <button
                type="button"
                id="retakeBtn"
                class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-md shadow hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition hidden"
              >
                Ambil Ulang
              </button>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
            <input type="hidden" id="photoData" name="photo" />
          </div>
          <button
            type="submit"
            class="w-full bg-blue-600 text-white font-semibold py-3 rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          >
            Tambah Tamu
          </button>
        </form>
      </section>

      <section>
        <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b-4 border-blue-600 pb-3">
          Upload Dokumentasi
        </h2>
        <form
          id="upload-doc-form"
          action="/upload_documentation/<%= event.id %>"
          method="POST"
          enctype="multipart/form-data"
          class="space-y-6 max-w-md mx-auto bg-white p-6 rounded-lg shadow-md"
        >
          <div>
            <label for="documentation" class="block mb-2 font-semibold text-gray-700">
              Pilih File Dokumentasi
            </label>
            <input
              type="file"
              id="documentation"
              name="documentation"
              accept="image/*,video/*,application/pdf"
              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              required
            />
          </div>
          <button
            type="submit"
            class="w-full bg-blue-600 text-white font-semibold py-3 rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
          >
            Upload
          </button>
        </form>
        <div
          id="documentation-list"
          class="mt-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 max-w-7xl mx-auto"
        >
          <% documentation.forEach(doc => { %>
          <div
            class="bg-white rounded-lg shadow-md p-4 flex flex-col items-center justify-center hover:shadow-lg transition-shadow relative"
          >
            <% if (doc.file_type.startsWith('image/')) { %>
            <img
              src="<%= doc.file_url %>"
              alt="Dokumentasi"
              class="w-full h-40 object-cover rounded-md cursor-pointer"
              data-doc-url="<%= doc.file_url %>"
              onclick="openDocModal(this)"
            />
            <a
              href="<%= doc.file_url %>"
              download
              class="mt-2 inline-block px-3 py-1 bg-blue-600 text-white rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
              aria-label="Download Dokumentasi"
            >
              Download Foto
            </a>
            <% } else if (doc.file_type.startsWith('video/')) { %>
            <video controls class="w-full h-40 rounded-md">
              <source src="<%= doc.file_url %>" type="<%= doc.file_type %>" />
              Browser Anda tidak mendukung video.
            </video>
            <% } else { %>
            <a
              href="<%= doc.file_url %>"
              target="_blank"
              class="text-blue-600 underline font-medium hover:text-blue-800 transition"
            >
              Lihat Dokumentasi
            </a>
            <% } %>
            <form
              action="/delete_documentation/<%= doc.id %>"
              method="POST"
              onsubmit="return confirmDelete(event, this);"
              class="absolute top-2 right-2"
            >
              <button
                type="submit"
                class="inline-block px-3 py-1 bg-red-600 text-white rounded-md shadow hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition"
                aria-label="Hapus Dokumentasi"
              >
                Hapus
              </button>
            </form>
          </div>
          <% }) %>
        </div>

        <!-- Documentation Image Modal -->
        <div id="doc-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
          <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full p-4 relative">
            <button id="close-doc-modal" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900 text-3xl font-bold focus:outline-none">&times;</button>
            <img id="doc-modal-img" src="" alt="Dokumentasi" class="max-h-[80vh] mx-auto rounded-md" />
          </div>
        </div>
      </section>
    </main>
    <footer
      class="bg-white text-center p-6 text-gray-500 text-sm border-t border-gray-200"
    >
      &copy; 2024 Event Management
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      function confirmDelete(event, form) {
        event.preventDefault();
        Swal.fire({
          title: "Apakah Anda yakin?",
          text: "Data tamu akan dihapus permanen!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#dc2626",
          cancelButtonColor: "#6b7280",
          confirmButtonText: "Ya, hapus!",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
        return false;
      }
    </script>

    <script>
      const uploadDocForm = document.getElementById('upload-doc-form');
      uploadDocForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(uploadDocForm);
        try {
          const response = await fetch(uploadDocForm.action, {
            method: 'POST',
            body: formData,
          });
          if (!response.ok) {
            const text = await response.text();
            Swal.fire({
              icon: 'error',
              title: 'Upload gagal',
              text: text,
            });
            return;
          }
          const result = await response.json();
          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'Upload berhasil',
              showConfirmButton: false,
              timer: 1500
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Upload gagal',
              text: 'Terjadi kesalahan saat mengupload dokumentasi.',
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Terjadi kesalahan',
            text: error.message,
          });
        }
      });
    </script>

    <!-- Invitation Modal -->
    <div id="invitation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-8 relative">
        <button id="close-invitation-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 text-3xl font-bold focus:outline-none">&times;</button>
        <div id="invitation-content" class="text-center p-4">
          <h2 class="text-4xl font-extrabold mb-6 border-b border-gray-300 pb-3">Undangan Acara</h2>
          <p id="guest-name" class="text-2xl font-semibold mb-8"></p>
          <div id="qrcode" class="mx-auto mb-8 w-48 h-48 flex items-center justify-center border border-gray-300 rounded-lg shadow-inner bg-white">
            <canvas id="qrcode-canvas" class="w-44 h-44"></canvas>
          </div>
          <p class="mb-8 text-gray-700 text-lg">
            Anda diundang untuk menghadiri acara kami. Silakan scan QR code di atas untuk konfirmasi kehadiran dan informasi lebih lanjut.
          </p>
          <button id="print-invitation" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-semibold shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-400">Cetak Undangan</button>
          <button id="download-qr" class="ml-4 bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition font-semibold shadow-lg focus:outline-none focus:ring-4 focus:ring-green-400">Download QR Code</button>
        </div>
      </div>
    </div>

    <script>
      // Invitation modal elements
      const invitationModal = document.getElementById('invitation-modal');
      const closeInvitationModalBtn = document.getElementById('close-invitation-modal');
      const invitationContent = document.getElementById('invitation-content');
      const guestNameElem = document.getElementById('guest-name');
      const qrCodeContainer = document.getElementById('qrcode');
      const printInvitationBtn = document.getElementById('print-invitation');

      // Show invitation modal with QR code
      document.querySelectorAll('.print-invitation-btn').forEach(button => {
        button.addEventListener('click', () => {
          const guestId = button.getAttribute('data-guest-id');
          const guestName = button.getAttribute('data-guest-name');
          guestNameElem.textContent = `Undangan untuk: ${guestName}`;
          // Clear the canvas before drawing new QR code
          const canvas = document.getElementById('qrcode-canvas');
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const thankYouUrl = `${window.location.origin}/thankyou/${guestId}`;
          QRCode.toCanvas(canvas, thankYouUrl, { width: 180 }, function (error) {
            if (error) console.error(error);
          });
          invitationModal.classList.remove('hidden');
        });
      });

      // Close modal
      closeInvitationModalBtn.addEventListener('click', () => {
        invitationModal.classList.add('hidden');
      });
      
      // Print invitation
      printInvitationBtn.addEventListener('click', () => {
        // Add delay to ensure QR code is rendered before printing
        setTimeout(() => {
          // Convert canvas to image for printing
          const canvas = document.getElementById('qrcode-canvas');
          const imgDataUrl = canvas.toDataURL();
          const img = document.createElement('img');
          img.src = imgDataUrl;
          // Explicitly set width and height to fixed pixels
          img.style.width = '180px';
          img.style.height = '180px';
          // Clone invitation content
          const printContents = invitationContent.cloneNode(true);
          // Replace canvas with image in cloned content
          const qrCodeDiv = printContents.querySelector('#qrcode');
          const canvasInClone = printContents.querySelector('canvas');
          if (canvasInClone) {
            qrCodeDiv.replaceChild(img, canvasInClone);
          }
          const originalContents = document.body.innerHTML;
          document.body.innerHTML = '';
          document.body.appendChild(printContents);
          // Wait for image to load before printing
          img.onload = () => {
            window.print();
            document.body.innerHTML = originalContents;
            // Remove reload to avoid issues
            // window.location.reload();
          };
        }, 300);
      });

      // Download QR code as image
      const downloadQRBtn = document.getElementById('download-qr');
      downloadQRBtn.addEventListener('click', () => {
        const canvas = document.getElementById('qrcode-canvas');
        const imgDataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imgDataUrl;
        // Use the URL encoded in the QR code to generate filename
        const qrUrl = canvas.getAttribute('data-qr-url') || '';
        let filename = 'qr-code.png';
        if (qrUrl) {
          try {
            const urlObj = new URL(qrUrl);
            const pathname = urlObj.pathname.replace(/\//g, '-').replace(/^-|-$/g, '');
            filename = `qr-${pathname || 'code'}.png`;
          } catch {
            // fallback filename
          }
        }
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    </script>

    <script>
      // Documentation modal open and close functions
      const docModal = document.getElementById('doc-modal');
      const docModalImg = document.getElementById('doc-modal-img');
      const closeDocModalBtn = document.getElementById('close-doc-modal');

      function openDocModal(imgElem) {
        const url = imgElem.getAttribute('data-doc-url');
        docModalImg.src = url;
        docModal.classList.remove('hidden');
      }

      closeDocModalBtn.addEventListener('click', () => {
        docModal.classList.add('hidden');
        docModalImg.src = '';
      });

      // Close modal on clicking outside the image
      docModal.addEventListener('click', (e) => {
        if (e.target === docModal) {
          docModal.classList.add('hidden');
          docModalImg.src = '';
        }
      });
    </script>
</create_file>
